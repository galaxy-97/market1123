{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
股息金额确定
{% endblock %}

{% block content %}

<!-- 玩家ID提示 -->
<div class="alert alert-info mb-4">
    <strong>您的玩家ID：{{ player_id }}</strong>（请记住此ID，用于结果查询）
</div>

<!-- 新增：页面介绍区域 -->
<div class="well mb-4" style="padding: 15px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
    <p><strong>页面说明：</strong>本页用于确定本期资产的具体付息金额。左侧为付息金额的参照矩阵，右侧为交互确认区域（为左侧矩阵的乱序版）。请点击右侧任意色块完成“付息金额”的确定，系统将随机抽取一名参与者的结果作为本期真实结果。</p>
</div>

<div style="display: flex; gap: 30px; margin: 30px 0; overflow-x: auto; padding-bottom: 10px;">
    <!-- 第二个矩阵及解释+概率表格 -->
    <div>
        <p style="text-align: center; font-weight: bold;">参照矩阵</p>
        <div id="matrix2" style="display: grid; grid-template-columns: repeat(12, 20px); gap: 2px; border: 2px solid #333; padding: 5px;"></div>

        <!-- 始终显示表格，概率列根据part2显示“未知”或“数值%” -->
        <div style="margin-top: 20px;">
            <table style="border-collapse: collapse; width: 100%; text-align: center; margin: 0 auto;">
                <thead>
                    <tr style="border: 1px solid #333; background-color: #f0f0f0;">
                        <th style="border: 1px solid #333; padding: 8px;">颜色</th>
                        <th style="border: 1px solid #333; padding: 8px;">股息金额</th>
                        <th style="border: 1px solid #333; padding: 8px;">概率</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #333; padding: 8px;">
                            <span style="display: inline-block; width: 20px; height: 20px; background: red; border: 1px solid #999;"></span>
                            红色
                        </td>
                        <td style="border: 1px solid #333; padding: 8px;">8</td>
                        <td style="border: 1px solid #333; padding: 8px;">{% if part2 == 'risk' %}{{ red_prob }}%{% else %}未知{% endif %}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #333; padding: 8px;">
                            <span style="display: inline-block; width: 20px; height: 20px; background: yellow; border: 1px solid #999;"></span>
                            黄色
                        </td>
                        <td style="border: 1px solid #333; padding: 8px;">28</td>
                        <td style="border: 1px solid #333; padding: 8px;">{% if part2 == 'risk' %}{{ yellow_prob }}%{% else %}未知{% endif %}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #333; padding: 8px;">
                            <span style="display: inline-block; width: 20px; height: 20px; background: blue; border: 1px solid #999;"></span>
                            蓝色
                        </td>
                        <td style="border: 1px solid #333; padding: 8px;">60</td>
                        <td style="border: 1px solid #333; padding: 8px;">{% if part2 == 'risk' %}{{ blue_prob }}%{% else %}未知{% endif %}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 交互矩阵 -->
    <div>
        <p style="text-align: center; font-weight: bold;">（点击任意色块确认）</p>
        <div id="matrix3" style="display: grid; grid-template-columns: repeat(12, 20px); gap: 2px; border: 2px solid #333; padding: 5px;"></div>
    </div>
</div>

<!-- 隐藏表单 -->
<input type="hidden" name="clicked_index_page2" id="id_clicked_index" value="-1">
<input type="hidden" name="clicked_color_page2" id="id_clicked_color" value="">

{% next_button %}

{% endblock %}

{% block scripts %}
<script>
    const part2 = "{{ part2 }}";
    const totalCells = 12 * 12;
    const matrix2Original = {{ matrix2_original|json }};
    const matrix2HideRows = new Set({{ matrix2_hide_rows|json }});
    const matrix3Data = {{ matrix3_data|json }};  // 0=红，1=黄，2=蓝
    const colors = ['red', 'yellow', 'blue'];  // CSS颜色
    const colorNames = ['红色', '黄色', '蓝色'];  // 中文名称

    let matrix3Clicked = false;

    // 生成第二个矩阵
    function generateMatrix2() {
        const matrix = document.getElementById('matrix2');
        matrix.innerHTML = '';
        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.style.width = '20px';
            cell.style.height = '20px';
            cell.style.border = '1px solid #999';
            const row = Math.floor(i / 12);
            // 遮挡行用灰色覆盖
            cell.style.background = (part2 === 'ambi' && matrix2HideRows.has(row)) ? '#999' : 
                                   colors[matrix2Original[i]];
            matrix.appendChild(cell);
        }
    }

    // 生成第三个矩阵（灰色覆盖，点击显示红黄蓝）
    function generateMatrix3() {
        const matrix = document.getElementById('matrix3');
        matrix.innerHTML = '';
        for (let i = 0; i < totalCells; i++) {
            const container = document.createElement('div');
            container.style.position = 'relative';
            container.style.width = '20px';
            container.style.height = '20px';
            container.dataset.index = i;

            // 真实色块（红黄蓝）
            const realCell = document.createElement('div');
            realCell.style.width = '20px';
            realCell.style.height = '20px';
            realCell.style.border = '1px solid #999';
            realCell.style.background = colors[matrix3Data[i]];

            // 灰色覆盖层
            const overlay = document.createElement('div');
            overlay.style.position = 'absolute';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '20px';
            overlay.style.height = '20px';
            overlay.style.background = '#999';
            overlay.style.cursor = 'pointer';

            container.appendChild(realCell);
            container.appendChild(overlay);
            matrix.appendChild(container);
        }
        bindClickEvent();
    }

    // 绑定点击事件
    function bindClickEvent() {
        const matrix = document.getElementById('matrix3');
        const indexInput = document.getElementById('id_clicked_index');
        const colorInput = document.getElementById('id_clicked_color');

        matrix.addEventListener('click', (e) => {
            if (matrix3Clicked) return;

            const container = e.target.closest('div[data-index]');
            if (!container) return;

            const index = parseInt(container.dataset.index);
            const colorIdx = matrix3Data[index];  // 0=红，1=黄，2=蓝
            const color = colorNames[colorIdx];

            // 更新表单值
            indexInput.value = index;
            colorInput.value = color;

            // 显示所有色块并高亮点击位置
            matrix3Clicked = true;
            document.querySelectorAll('#matrix3 > div').forEach((el, idx) => {
                el.querySelector('div:nth-child(2)').remove();  // 移除覆盖层
                if (idx === index) {
                    el.querySelector('div').style.border = '3px solid #0f0';  // 绿色高亮
                }
            });
        });
    }

    // 页面加载时生成矩阵
    window.onload = () => {
        generateMatrix2();
        generateMatrix3();
    };
</script>
{% endblock %}