# 市场资产交易实验系统 (Market Asset Trading Experiment System)

## 项目简介

这是一个基于 oTree 5 框架开发的实验经济学应用，用于研究不确定性条件下的资产市场交易行为。该系统实现了连续双向拍卖市场（Continuous Double Auction），支持在风险（Risk）和模糊（Ambiguity）两种不确定性条件下进行多轮次、多资产的交易实验。

## 主要功能

### 1. 实验设计框架
- **多轮次交易**：支持最多10轮实验，每轮可独立配置参数
- **多资产支持**：最多支持4种不同资产（A、B、C、D）的同时交易
- **灵活配置**：通过CSV配置文件设置实验参数，无需修改代码
- **SSW市场支持**：可设置是否继承上一轮的资产和现金持有量

### 2. 不确定性条件设计

#### 风险条件（Risk）
- 明确的概率分布：显示各种状态的概率
- 股息支付概率透明可见
- 第一页：25%概率不付息（黑色），75%概率付息（白色）
- 第二页：三种股息水平各33.33%概率（红色、黄色、蓝色）

#### 模糊条件（Ambiguity）
- 不明确的概率分布：部分信息被遮挡
- 参与者无法完全了解真实概率
- 通过遮挡矩阵的部分行来实现信息不完全

### 3. 股息确定机制

**两阶段抽取流程**：

1. **第一阶段（DividendPage1）**：
   - 每位参与者点击12×12矩阵中的一个方格
   - 系统随机选择一位参与者的结果
   - 如抽到黑色：本期资产不付息，直接进入市场交易
   - 如抽到白色：进入第二阶段

2. **第二阶段（DividendPage2）**：
   - 仅在第一阶段抽到白色时执行
   - 参与者点击另一个12×12矩阵
   - 系统随机选择一位参与者的结果
   - 红色/黄色/蓝色对应不同的股息水平

### 4. 市场交易系统

#### 连续双向拍卖机制
- **实时撮合**：买单和卖单自动匹配成交
- **价格优先**：较好的价格优先成交
- **时间优先**：相同价格下较早的订单优先
- **即时交易**：参与者可提交限价单（Maker）或即时成交单（Taker）

#### 订单类型
- **买单（Bid）**：出价购买资产
- **卖单（Ask）**：要价出售资产
- **限价单（Maker）**：挂单等待成交
- **市价单（Taker）**：立即成交

#### 交易约束
- **现金约束**：买单总额不能超过持有现金
- **资产约束**：卖单数量不能超过持有资产
- **自我交易检查**：防止出价高于自己的要价或要价低于自己的出价

### 5. 数据收集

系统自动记录：
- 所有订单（买单/卖单）的详细信息
- 所有成交记录（价格、数量、时间戳）
- 每位参与者的交易历史
- 每轮的股息抽取结果
- 参与者的初始和最终资产持有量

### 6. 用户界面

- **实时市场信息**：当前最优买卖价、订单簿深度
- **个人交易界面**：提交订单、取消订单
- **交易历史**：查看个人和市场交易记录
- **资产状态**：实时显示持有现金和资产数量
- **股息信息**：显示各状态下的资产回报

## 技术架构

### 核心技术栈
- **框架**：oTree 5.x（基于Django的实验经济学框架）
- **后端**：Python 3.x
- **前端**：HTML5、JavaScript、Bootstrap
- **数据库**：oTree内置数据库（默认SQLite，可配置PostgreSQL）
- **实时通信**：WebSocket（通过oTree channels实现）

### 关键模块

#### 1. 配置管理（configmanager.py）
- CSV配置文件解析
- 参数验证和类型转换
- 缓存机制提升性能

#### 2. 市场逻辑（mk.py）
- 订单管理：创建、撤销、验证
- 交易撮合：价格匹配、时间优先
- 状态更新：买卖盘、成交记录

#### 3. 主程序（__init__.py）
- oTree模型定义：Subsession、Group、Player
- 页面流程控制
- 股息抽取逻辑
- 数据持久化

## 文件结构说明

```
market1123/
├── __init__.py              # 主程序：模型定义和页面逻辑
├── mk.py                    # 市场交易逻辑模块
├── configmanager.py         # 配置文件管理器
├── configs/
│   └── demo.csv            # 实验配置文件（轮次参数）
├── Market.html             # 市场交易页面
├── DividendPage1.html      # 股息抽取第一页
├── DividendPage2.html      # 股息抽取第二页
├── Instruction.html        # 实验说明页面
├── RoundResults.html       # 轮次结果页面
├── FinalResults.html       # 最终结果页面
├── Questionnaire.html      # 问卷调查页面
└── Demographic.html        # 人口统计信息页面
```

## 配置说明

### CSV配置文件格式

`configs/demo.csv` 包含以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| round_number | int | 轮次编号 |
| period_length | int | 交易时长（秒） |
| num_assets | int | 资产种类数量（1-4） |
| num_states | int | 状态数量 |
| asseta_endowments | str | 资产A初始分配（空格分隔的9个数字） |
| assetb_endowments | str | 资产B初始分配 |
| cash_endowment | str | 现金初始分配（空格分隔的9个数字） |
| practice | bool | 是否为练习轮 |
| a1, a2, a3 | int | 资产A在状态1-3的股息 |
| b1, b2, b3 | int | 资产B在状态1-3的股息 |
| p0, p1, p2, p3 | float | 各状态概率 |
| state_independent | bool | 资产状态是否独立 |
| ssw_inherit | bool | 是否继承上轮持有量 |
| treatment | str | 实验处理（如"risk_risk"、"risk_ambi"等） |

### Treatment编码说明

treatment字段格式：`{part1}_{part2}`

- **part1**：第一阶段（是否付息）的不确定性类型
- **part2**：第二阶段（股息水平）的不确定性类型

可选值：
- `risk`：风险（已知概率）
- `ambi`：模糊（未知概率）

示例：
- `risk_risk`：两阶段都是风险
- `risk_ambi`：第一阶段风险，第二阶段模糊
- `ambi_risk`：第一阶段模糊，第二阶段风险
- `ambi_ambi`：两阶段都是模糊

## 使用方法

### 1. 环境准备

```bash
# 安装oTree（需要Python 3.8+）
pip install otree

# 进入项目目录
cd market1123
```

### 2. 配置实验

编辑 `configs/demo.csv` 文件，设置：
- 轮次数量和时长
- 资产和现金初始分配
- 股息水平
- 实验条件（risk/ambi）

### 3. 运行实验

```bash
# 开发模式
otree devserver

# 生产模式
otree prodserver
```

### 4. 访问实验

在浏览器中访问：
- 开发模式：`http://localhost:8000`
- 按照提示创建session并分配参与者链接

### 5. 数据导出

```bash
# 导出所有数据
otree export

# 或通过Web界面导出（Data页面）
```

## 实验流程

1. **欢迎页面**：介绍实验基本信息
2. **说明页面**：详细的实验规则和操作指南
3. **等待页面**：等待所有参与者就绪
4. **股息抽取第一页**：确定是否付息
5. **股息抽取第二页**：确定股息水平（如付息）
6. **市场交易**：固定时长的交易阶段
7. **轮次结果**：显示本轮交易和收益情况
8. 重复步骤3-7（多轮次）
9. **问卷调查**：收集策略和反馈
10. **人口统计**：收集基本信息
11. **最终结果**：显示总收益和支付信息

## 数据结构

### 关键数据模型

#### Subsession（子会话）
- 轮次配置参数
- 股息抽取结果
- 状态信息

#### Group（组）
- 订单簿状态（trader_state）
- 交易历史（trader_state_history）
- 股息抽取结果

#### Player（参与者）
- 资产持有量（settled_assets）
- 现金持有量（settled_cash）
- 点击选择记录
- 问卷答案

## 特色功能

### 1. 动态概率显示
- 风险条件下显示精确概率
- 模糊条件下隐藏部分信息
- 视觉化的矩阵界面

### 2. 实时交易反馈
- 订单提交即时响应
- 成交通知实时推送
- 市场状态动态更新

### 3. 灵活的实验设计
- 支持多种treatment组合
- 可配置的参数系统
- 适应不同研究需求

### 4. 完整的数据追踪
- 每个订单的时间戳
- 完整的交易链路
- 便于后续分析

## 研究应用

该系统可用于研究：
- 模糊厌恶（Ambiguity Aversion）
- 资产定价行为
- 市场微观结构
- 信息不对称的影响
- 风险偏好测量

## 技术特点

1. **高性能**：使用缓存和异步处理优化性能
2. **可扩展**：模块化设计易于添加新功能
3. **稳定性**：完善的错误处理和数据验证
4. **用户友好**：直观的界面和清晰的反馈
5. **数据完整**：全面记录实验过程

## 注意事项

1. **参与者人数**：当前设置为每组9人，可在代码中修改 `PLAYERS_PER_GROUP`
2. **时间设置**：确保交易时长足够参与者完成交易
3. **网络要求**：需要稳定的网络连接以支持实时通信
4. **浏览器兼容**：建议使用Chrome或Firefox最新版本
5. **数据备份**：定期导出和备份实验数据

## 许可证

本项目用于学术研究目的。

## 联系方式

如有问题或建议，请通过GitHub Issues联系。
